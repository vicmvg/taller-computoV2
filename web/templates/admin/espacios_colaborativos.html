{% extends 'base.html' %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-users-cog me-2"></i>Espacios Colaborativos</h2>
            <p class="text-muted">Crea grupos de trabajo colaborativo entre alumnos</p>
        </div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCrearEspacio">
            <i class="fas fa-plus-circle me-2"></i>Crear Nuevo Espacio
        </button>
    </div>

    <!-- Estadísticas rápidas -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5><i class="fas fa-project-diagram me-2"></i>Espacios Activos</h5>
                    <h2>{{ espacios_activos|length }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5><i class="fas fa-users me-2"></i>Alumnos Participando</h5>
                    <h2>{{ alumnos|length }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-secondary text-white">
                <div class="card-body">
                    <h5><i class="fas fa-archive me-2"></i>Espacios Archivados</h5>
                    <h2>{{ espacios_inactivos|length }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs para Activos/Inactivos -->
    <ul class="nav nav-tabs mb-3" id="espaciosTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="activos-tab" data-bs-toggle="tab" data-bs-target="#activos" type="button">
                <i class="fas fa-check-circle me-1"></i>Activos ({{ espacios_activos|length }})
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="inactivos-tab" data-bs-toggle="tab" data-bs-target="#inactivos" type="button">
                <i class="fas fa-archive me-1"></i>Archivados ({{ espacios_inactivos|length }})
            </button>
        </li>
    </ul>

    <div class="tab-content" id="espaciosTabsContent">
        <!-- Tab Espacios Activos -->
        <div class="tab-pane fade show active" id="activos">
            {% if espacios_activos %}
                <div class="row">
                    {% for espacio in espacios_activos %}
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card h-100 shadow-sm hover-shadow">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-folder-open text-primary me-2"></i>
                                        {{ espacio.titulo }}
                                    </h5>
                                    <span class="badge bg-success">Activo</span>
                                </div>
                                
                                {% if espacio.descripcion %}
                                <p class="card-text text-muted small">
                                    {{ espacio.descripcion[:100] }}{% if espacio.descripcion|length > 100 %}...{% endif %}
                                </p>
                                {% endif %}

                                <div class="mb-3">
                                    <small class="text-muted">
                                        <i class="fas fa-users me-1"></i>
                                        {{ espacio.miembros|length }} miembros
                                    </small>
                                    <br>
                                    <small class="text-muted">
                                        <i class="fas fa-calendar me-1"></i>
                                        Creado: {{ espacio.fecha_creacion.strftime('%d/%m/%Y') }}
                                    </small>
                                    {% if espacio.fecha_entrega %}
                                    <br>
                                    <small class="text-warning">
                                        <i class="fas fa-flag me-1"></i>
                                        Entrega: {{ espacio.fecha_entrega.strftime('%d/%m/%Y') }}
                                    </small>
                                    {% endif %}
                                </div>

                                <div class="d-flex justify-content-between">
                                    <a href="{{ url_for('admin.ver_espacio_colaborativo', espacio_id=espacio.id) }}" 
                                       class="btn btn-sm btn-primary">
                                        <i class="fas fa-eye me-1"></i>Ver Detalles
                                    </a>
                                    <button class="btn btn-sm btn-warning" 
                                            data-id="{{ espacio.id }}" 
                                            data-titulo="{{ espacio.titulo }}"
                                            onclick="desactivarEspacio(this)">
                                        <i class="fas fa-power-off me-1"></i>Desactivar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    No hay espacios colaborativos activos. Crea uno para comenzar.
                </div>
            {% endif %}
        </div>

        <!-- Tab Espacios Inactivos -->
        <div class="tab-pane fade" id="inactivos">
            {% if espacios_inactivos %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Título</th>
                                <th>Miembros</th>
                                <th>Fecha Creación</th>
                                <th>Fecha Desactivación</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for espacio in espacios_inactivos %}
                            <tr>
                                <td>
                                    <i class="fas fa-folder text-muted me-2"></i>
                                    {{ espacio.titulo }}
                                </td>
                                <td>{{ espacio.miembros|length }}</td>
                                <td>{{ espacio.fecha_creacion.strftime('%d/%m/%Y') }}</td>
                                <td>{{ espacio.fecha_desactivacion.strftime('%d/%m/%Y %H:%M') if espacio.fecha_desactivacion else '-' }}</td>
                                <td>
                                    <button class="btn btn-sm btn-success" 
                                            data-id="{{ espacio.id }}"
                                            data-titulo="{{ espacio.titulo }}"
                                            onclick="reactivarEspacio(this)">
                                        <i class="fas fa-redo me-1"></i>Reactivar
                                    </button>
                                    <button class="btn btn-sm btn-danger" 
                                            data-id="{{ espacio.id }}"
                                            data-titulo="{{ espacio.titulo }}"
                                            onclick="eliminarEspacio(this)">
                                        <i class="fas fa-trash me-1"></i>Eliminar
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    No hay espacios colaborativos archivados.
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal Crear Espacio -->
<div class="modal fade" id="modalCrearEspacio" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('admin.crear_espacio_colaborativo') }}">
                {{ csrf_token() }}
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-plus-circle me-2"></i>Crear Espacio Colaborativo
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label"><strong>Título del Proyecto *</strong></label>
                        <input type="text" class="form-control" name="titulo" required 
                               placeholder="Ej: Proyecto de Ciencias - Sistema Solar">
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><strong>Descripción</strong></label>
                        <textarea class="form-control" name="descripcion" rows="3" 
                                  placeholder="Describe brevemente el proyecto colaborativo..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><strong>Fecha de Entrega</strong></label>
                        <input type="date" class="form-control" name="fecha_entrega">
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><strong>Seleccionar Alumnos (mínimo 2) *</strong></label>
                        <div class="row">
                            {% for alumno in alumnos %}
                            <div class="col-md-6 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input alumno-checkbox" type="checkbox" 
                                           name="alumnos" value="{{ alumno.id }}" 
                                           id="alumno{{ alumno.id }}">
                                    <label class="form-check-label" for="alumno{{ alumno.id }}">
                                        {{ alumno.nombre_completo }} 
                                        <small class="text-muted">({{ alumno.grado_grupo }})</small>
                                    </label>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <small class="text-muted">Seleccionados: <span id="contadorSeleccionados">0</span></small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="btnCrearEspacio" disabled>
                        <i class="fas fa-check me-1"></i>Crear Espacio
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Forms ocultos para acciones -->
<form id="formDesactivar" method="POST" style="display:none;">
    {{ csrf_token() }}
    <input type="hidden" name="espacio_id">
</form>

<form id="formReactivar" method="POST" style="display:none;">
    {{ csrf_token() }}
    <input type="hidden" name="espacio_id">
</form>

<form id="formEliminar" method="POST" style="display:none;">
    {{ csrf_token() }}
    <input type="hidden" name="espacio_id">
</form>

<style>
.hover-shadow {
    transition: all 0.3s ease;
}
.hover-shadow:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.2) !important;
}
</style>

<script>
// Contador de alumnos seleccionados
document.querySelectorAll('.alumno-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const seleccionados = document.querySelectorAll('.alumno-checkbox:checked').length;
        document.getElementById('contadorSeleccionados').textContent = seleccionados;
        document.getElementById('btnCrearEspacio').disabled = seleccionados < 2;
    });
});

function desactivarEspacio(btn) {
    const id = btn.dataset.id;
    const titulo = btn.dataset.titulo;
    if (confirm(`¿Estás seguro de desactivar el espacio "${titulo}"?\n\nEsto eliminará todos los archivos y datos del espacio.`)) {
        const form = document.getElementById('formDesactivar');
        form.action = `/admin/espacios-colaborativos/${id}/desactivar`;
        form.submit();
    }
}

function reactivarEspacio(btn) {
    const id = btn.dataset.id;
    const titulo = btn.dataset.titulo;
    if (confirm(`¿Reactivar el espacio "${titulo}"?`)) {
        const form = document.getElementById('formReactivar');
        form.action = `/admin/espacios-colaborativos/${id}/reactivar`;
        form.submit();
    }
}

function eliminarEspacio(btn) {
    const id = btn.dataset.id;
    const titulo = btn.dataset.titulo;
    if (confirm(`¿ELIMINAR PERMANENTEMENTE el espacio "${titulo}"?\n\nEsta acción NO se puede deshacer.`)) {
        const form = document.getElementById('formEliminar');
        form.action = `/admin/espacios-colaborativos/${id}/eliminar`;
        form.submit();
    }
}
</script>
{% endblock %}