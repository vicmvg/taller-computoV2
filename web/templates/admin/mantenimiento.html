{% extends 'base.html' %}

{% block content %}
<div class="container py-4">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold" style="color: #1e293b;">Bitácora de Mantenimiento</h2>
            <p class="text-muted mb-0">Control de fallas y reparaciones.</p>
        </div>
        <button class="btn btn-danger shadow-sm" data-bs-toggle="modal" data-bs-target="#modalReportar">
            <i class="fas fa-exclamation-triangle me-2"></i>Reportar Falla
        </button>
    </div>

    <h5 class="fw-bold text-danger mb-3"><i class="fas fa-tools me-2"></i>En Reparación (Pendientes)</h5>
    
    <div class="row g-3 mb-5">
        {% for reporte in pendientes %}
        <div class="col-md-6">
            <div class="glass-card border-start border-4 border-danger p-3 position-relative">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <span class="badge bg-danger mb-2">ID Equipo: {{ reporte.equipo.id }}</span>
                        <h5 class="fw-bold text-dark">{{ reporte.equipo.tipo }} {{ reporte.equipo.marca }}</h5>
                        <p class="text-muted small mb-2"><i class="far fa-clock me-1"></i> {{ reporte.fecha_reporte.strftime('%d/%m/%Y %H:%M') }}</p>
                        <p class="mb-3 text-danger fw-bold">"{{ reporte.descripcion_falla }}"</p>
                    </div>
                    <i class="fas fa-wrench fa-3x text-danger opacity-25"></i>
                </div>
                
                <button class="btn btn-outline-success btn-sm w-100" 
                        data-bs-toggle="modal" 
                        data-bs-target="#modalSolucion"
                        data-reporte-id="{{ reporte.id }}"
                        data-equipo-nombre="{{ reporte.equipo.tipo }} {{ reporte.equipo.marca }}">
                    <i class="fas fa-check me-2"></i>Marcar como Reparado
                </button>
            </div>
        </div>
        {% else %}
        <div class="col-12">
            <div class="alert alert-success border-0 shadow-sm text-center">
                <i class="fas fa-check-circle fa-2x mb-2 d-block"></i>
                ¡Todo excelente! No hay equipos dañados por ahora.
            </div>
        </div>
        {% endfor %}
    </div>

    <h5 class="fw-bold text-secondary mb-3"><i class="fas fa-history me-2"></i>Historial Reciente</h5>
    <div class="glass-card p-0 overflow-hidden">
        <table class="table table-hover mb-0 small">
            <thead class="bg-light">
                <tr>
                    <th class="ps-4">Equipo</th>
                    <th>Falla Reportada</th>
                    <th>Solución Aplicada</th>
                    <th>Fecha Reparación</th>
                </tr>
            </thead>
            <tbody>
                {% for log in historial %}
                <tr>
                    <td class="ps-4 fw-bold">{{ log.equipo.tipo }} {{ log.equipo.marca }}</td>
                    <td class="text-danger">{{ log.descripcion_falla }}</td>
                    <td class="text-success"><i class="fas fa-check me-1"></i> {{ log.solucion }}</td>
                    <td class="text-muted">{{ log.fecha_reparacion.strftime('%d/%m/%Y') }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="4" class="text-center py-3 text-muted">Sin historial reciente.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Reportar Falla -->
<div class="modal fade" id="modalReportar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title fw-bold">Reportar Nueva Falla</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('admin.reportar_falla') }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Equipo Afectado</label>
                        <select class="form-select" name="equipo_id" required>
                            <option value="" selected disabled>Selecciona un equipo...</option>
                            {% for eq in equipos %}
                                <option value="{{ eq.id }}">#{{ eq.id }} - {{ eq.tipo }} {{ eq.marca }} ({{ eq.modelo }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Descripción del Problema</label>
                        <textarea class="form-control" name="descripcion" rows="3" placeholder="Ej. Pantalla azul, no enciende, hace ruido..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Registrar Falla</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Solución -->
<div class="modal fade" id="modalSolucion" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title fw-bold">Finalizar Reparación</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('admin.solucionar_falla') }}" method="POST">
                <input type="hidden" name="reporte_id" id="inputReporteId">
                
                <div class="modal-body">
                    <div class="alert alert-light border mb-3">
                        <small class="text-muted d-block">Reparando equipo:</small>
                        <strong id="nombreEquipoReparar" class="text-primary">...</strong>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">¿Qué solución aplicaste?</label>
                        <textarea class="form-control" name="solucion" rows="3" placeholder="Ej. Se formateó, cambio de cable, limpieza..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Guardar y Cerrar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Evento moderno que usa data attributes en lugar de onclick
    document.addEventListener('DOMContentLoaded', function() {
        const modalSolucion = document.getElementById('modalSolucion');
        
        modalSolucion.addEventListener('show.bs.modal', function(event) {
            // Botón que disparó el modal
            const button = event.relatedTarget;
            
            // Extraer info de data attributes
            const reporteId = button.getAttribute('data-reporte-id');
            const equipoNombre = button.getAttribute('data-equipo-nombre');
            
            // Actualizar contenido del modal
            document.getElementById('inputReporteId').value = reporteId;
            document.getElementById('nombreEquipoReparar').textContent = equipoNombre;
        });
    });
</script>
{% endblock %}